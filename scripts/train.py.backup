#!/usr/bin/env python
"""
Training script - Simple entry point.

All logic is in src/runner/train_runner.py.
This script just handles CLI arguments.

Examples:
    # Basic training
    uv run python scripts/train.py --model csnet --data octa500_3m
    
    # Custom hyperparameters
    uv run python scripts/train.py --model csnet --data octa500_3m \\
        --epochs 100 --batch-size 16 --lr 0.001
    
    # Diffusion with soft labels
    uv run python scripts/train.py --model medsegdiff --data octa500_3m \\
        --soft-label thickness --timesteps 1000
    
    # Debug mode (fast iteration)
    uv run python scripts/train.py --model csnet --data octa500_3m --debug
    
    # Resume training
    uv run python scripts/train.py --model csnet --data octa500_3m \\
        --resume experiments/csnet/octa500_3m/20250124_150000/checkpoints/last.ckpt
"""

import os
os.environ['NCCL_P2P_DISABLE'] = '1'

import torch
torch.set_float32_matmul_precision('medium')

import argparse
import autorootcwd

from src.runner import TrainRunner
from src.registry import list_models, list_datasets


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description='Train vessel segmentation models',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__
    )
    
    # Required
    parser.add_argument('--model', type=str, required=True,
                       help=f'Model name. Available: {", ".join(list_models())}')
    parser.add_argument('--data', type=str, required=True,
                       help=f'Dataset name. Available: {", ".join(list_datasets())}')
    
    # Training config
    parser.add_argument('--epochs', type=int, help='Max epochs (default: from model)')
    parser.add_argument('--batch-size', type=int, help='Batch size (default: 8)')
    parser.add_argument('--lr', type=float, help='Learning rate (default: from model)')
    parser.add_argument('--crop-size', type=int, help='Crop size (default: 224)')
    parser.add_argument('--gpu', type=int, default=0, help='GPU device ID')
    
    # Diffusion-specific
    parser.add_argument('--soft-label', type=str, default='none',
                       choices=['none', 'thickness', 'faz'],
                       help='Soft label type for diffusion models')
    parser.add_argument('--soft-label-fg-max', type=int, default=11,
                       help='Max foreground distance for soft labels')
    parser.add_argument('--soft-label-thickness-max', type=int, default=13,
                       help='Max thickness value for soft labels')
    parser.add_argument('--timesteps', type=int, default=1000,
                       help='Diffusion timesteps')
    parser.add_argument('--no-ema', action='store_true',
                       help='Disable EMA for diffusion models')
    parser.add_argument('--ema-decay', type=float, default=0.9999,
                       help='EMA decay rate')
    parser.add_argument('--ensemble', type=int, default=1,
                       help='Number of ensemble samples')
    
    # Experiment
    parser.add_argument('--tag', type=str, help='Experiment tag')
    parser.add_argument('--debug', action='store_true',
                       help='Debug mode (2 epochs, small data)')
    parser.add_argument('--resume', type=str, help='Resume from checkpoint')
    
    return parser.parse_args()


def main():
    """Main entry point."""
    args = parse_args()
    
    # Create runner with all config
    runner = TrainRunner(
        model_name=args.model,
        dataset_name=args.data,
        # Training
        epochs=args.epochs,
        batch_size=args.batch_size,
        learning_rate=args.lr,
        crop_size=args.crop_size,
        gpu=args.gpu,
        # Diffusion
        soft_label_type=args.soft_label,
        soft_label_fg_max=args.soft_label_fg_max,
        soft_label_thickness_max=args.soft_label_thickness_max,
        timesteps=args.timesteps,
        use_ema=not args.no_ema,
        ema_decay=args.ema_decay,
        num_ensemble=args.ensemble,
        # Experiment
        tag=args.tag,
        debug=args.debug,
        resume=args.resume,
    )
    
    # Run training (all logic in runner)
    runner.run()


if __name__ == '__main__':
    main()
